-- ================================================================
-- RE:FACTOR AUTO MOVE SYSTEM
-- Auto-integrates with main script when globals are available
-- ================================================================

-- Wait for main script to be ready
local function waitForMainScript()
    local maxWait = 30 -- Maximum 30 seconds
    local waited = 0
    
    while waited < maxWait do
        -- Check multiple possible global locations
        local Library = getgenv and getgenv().Library or _G.Library
        local Window = getgenv and getgenv().Window or _G.Window
        local Tabs = getgenv and getgenv().Tabs or _G.Tabs
        local MainScriptLoaded = getgenv and getgenv().MainScriptLoaded or _G.MainScriptLoaded
        
        if Library and Window and Tabs and MainScriptLoaded then
            print("‚úÖ Auto Move: Main script globals found!")
            return Library, Window, Tabs
        end
        
        task.wait(0.5)
        waited = waited + 0.5
    end
    
    error("‚ùå Auto Move: Main script not ready after " .. maxWait .. " seconds")
end

-- Get references to main script components
local Library, Window, Tabs = waitForMainScript()

-- ================================================================
-- SERVICES SETUP
-- ================================================================
local Services = {
    Workspace = game:GetService("Workspace"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Players = game:GetService("Players"),
    RunService = game:GetService("RunService"),
    TweenService = game:GetService("TweenService")
}

local LocalPlayer = Services.Players.LocalPlayer

-- ================================================================
-- ADD AUTO MOVE GROUPBOX TO ESSENTIAL TAB
-- ================================================================
local AutoMoveGroupBox = Tabs.Essential:AddLeftGroupbox("Auto Move üöÄ")

-- ================================================================
-- PLANT MOVE SYSTEM
-- ================================================================

-- Variables for Plant Move System
local PlantsToMove = {}
local PlantsToMoveTo = {}
local PlantMoveEnabled = false

-- Complete list of all plants and fruits in the game
local AllPlantsAndFruits = {
    "Aloe Vera", "Apple", "Avocado", "Bamboo", "Banana", "Beanstalk", "Bee Balm", "Bell Pepper",
    "Bendboo", "Blood Banana", "Blue Lollipop", "Blueberry", "Bone Blossom", "Boneboo", "Burning Bud", 
    "Cacao", "Cactus", "Candy Blossom", "Candy Sunflower", "Cantaloupe", "Carrot", "Cauliflower", 
    "Celestiberry", "Cherry Blossom", "Cherry OLD", "Chocolate Carrot", "Cocovine", "Coconut", "Corn", 
    "Cranberry", "Crimson Vine", "Crocus", "Cursed Fruit", "Daffodil", "Dandelion", "Delphinium", 
    "Dragon Fruit", "Dragon Pepper", "Durian", "Easter Egg", "Eggplant", "Elephant Ears", "Ember Lily", 
    "Feijoa", "Firefly Fern", "Firework Flower", "Fossilight", "Foxglove", "Glowshroom", "Grape", 
    "Green Apple", "Guanabana", "Hive Fruit", "Honeysuckle", "Horned Dinoshroom", "Ice Cream Bean", 
    "Kiwi", "Lavender", "Lemon", "Liberty Lily", "Lilac", "Lily of the Valley", "Lime", "Loquat", 
    "Lotus", "Lumira", "Mango", "Manuka Flower", "Mega Mushroom", "Merica Mushroom", "Mint", 
    "Moon Blossom", "Moon Mango", "Moon Melon", "Moonflower", "Moonglow", "Mushroom", "Nectar Thorn", 
    "Nectarine", "Nectarshade", "Nightshade", "Noble Flower", "Orange Tulip", "Papaya", "Paradise Petal", 
    "Parasol Flower", "Passionfruit", "Peace Lily", "Peach", "Pear", "Pepper", "Pineapple", "Pink Lily", 
    "Pink Tulip", "Pitcher Plant", "Prickly Pear", "Pumpkin", "Purple Cabbage", "Purple Dahlia", 
    "Rafflesia", "Raspberry", "Red Lollipop", "Rose", "Rosy Delight", "Soul Fruit", "Starfruit", 
    "Stonebite", "Strawberry", "Succulent", "Sugar Apple", "Suncoil", "Sunflower", "Tomato", 
    "Traveler's Fruit", "Venus Fly Trap", "Violet Corn", "Watermelon", "White Mulberry", "Wild Carrot"
}

-- Plants to move FROM dropdown
AutoMoveGroupBox:AddDropdown("PlantsToMove", {
    Values = AllPlantsAndFruits,
    Default = {},
    Multi = true,
    Text = "Plants Wanna Move",
    Tooltip = "Select which plant types you want to move (ALL plants of selected types)",
    Callback = function(Value)
        PlantsToMove = Value
        print("[cb] Plants to move updated:", Value)
        
        -- Show selected plants in notification
        local selectedNames = {}
        for plantName, isSelected in pairs(Value) do
            if isSelected then
                table.insert(selectedNames, plantName)
            end
        end
        
        if #selectedNames > 0 then
            print("üå± Will move ALL:", table.concat(selectedNames, ", "))
        else
            print("üå± No plants selected to move")
        end
    end,
})

-- Plants to move TO dropdown
AutoMoveGroupBox:AddDropdown("PlantsToMoveTo", {
    Values = AllPlantsAndFruits,
    Default = {},
    Multi = true,
    Text = "Plants Wanna Move To",
    Tooltip = "Select where you want to move the plants to",
    Callback = function(Value)
        PlantsToMoveTo = Value
        print("[cb] Plants to move to updated:", Value)
        
        -- Show selected target plants in notification
        local selectedNames = {}
        for plantName, isSelected in pairs(Value) do
            if isSelected then
                table.insert(selectedNames, plantName)
            end
        end
        
        if #selectedNames > 0 then
            print("üéØ Moving to:", table.concat(selectedNames, ", "))
        else
            print("üéØ No target plants selected")
        end
    end,
})

-- ================================================================
-- PLANT MOVE IMPLEMENTATION
-- ================================================================

-- Additional variables for plant moving
local plantMoveConnection = nil
local currentlyMovingPlants = {} -- Track plants currently being moved
local movedPlants = {} -- Track plants that have already been moved
local lastMoveTime = 0 -- Track time of last move to add delays

-- Function to get player's farm
local function getMyFarm()
    for _, farm in Services.Workspace.Farm:GetChildren() do
        local important = farm:FindFirstChild("Important")
        if important then
            local data = important:FindFirstChild("Data")
            if data and data:FindFirstChild("Owner") and data.Owner.Value == LocalPlayer.Name then
                return farm
            end
        end
    end
    return nil
end

-- Function to find and equip trowel tool
local function findAndEquipTrowel()
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if not backpack then 
        return nil
    end

    -- Check if trowel is already equipped
    if LocalPlayer.Character then
        for _, equippedItem in pairs(LocalPlayer.Character:GetChildren()) do
            if equippedItem:IsA("Tool") and string.find(equippedItem.Name, "Trowel") then
                return equippedItem
            end
        end
    end

    -- Look for trowel in backpack
    local trowelTool = nil
    for _, item in pairs(backpack:GetChildren()) do
        if item:IsA("Tool") and string.find(item.Name, "Trowel") then
            trowelTool = item
            break
        end
    end

    -- Equip the trowel tool
    if trowelTool and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid:EquipTool(trowelTool)
        task.wait(0.5)
        return LocalPlayer.Character:FindFirstChild(trowelTool.Name)
    end
    
    return nil
end

-- Function to find plants by name pattern
local function findPlantsByName(plantName)
    local myFarm = getMyFarm()
    if not myFarm then
        return {}
    end

    local important = myFarm:FindFirstChild("Important")
    if not important then
        return {}
    end

    local plantsPhysical = important:FindFirstChild("Plants_Physical")
    if not plantsPhysical then
        return {}
    end

    local foundPlants = {}
    for _, plant in pairs(plantsPhysical:GetChildren()) do
        if string.find(plant.Name:lower(), plantName:lower()) then
            table.insert(foundPlants, plant)
        end
    end
    
    return foundPlants
end

-- Function to get target plant's position directly
local function getTargetPlantPosition(targetPlantName)
    -- Find target plants
    local targetPlants = findPlantsByName(targetPlantName)
    if #targetPlants == 0 then
        return nil
    end

    -- Get the first target plant's position directly
    local targetPlant = targetPlants[1]
    return targetPlant:GetPivot().Position
end

-- Function to move a single plant
local function movePlant(plantToMove, targetPlantName)
    local plantId = tostring(plantToMove)
    
    -- Check if this specific plant is already being moved
    if currentlyMovingPlants[plantId] then
        return false
    end
    
    -- Mark this plant as currently being moved
    currentlyMovingPlants[plantId] = true
    
    local moveSuccess = false
    
    local success = pcall(function()
        -- Find and equip trowel
        local trowelTool = findAndEquipTrowel()
        if not trowelTool then
            print("‚ùå Need a Trowel tool in inventory!")
            return
        end

        -- Get target plant position directly
        local targetPosition = getTargetPlantPosition(targetPlantName)
        if not targetPosition then
            print("‚ùå Target plant not found:", targetPlantName)
            return
        end

        -- Get the TrowelRemote
        local TrowelRemote = Services.ReplicatedStorage.GameEvents:FindFirstChild("TrowelRemote")
        if not TrowelRemote then
            print("‚ùå TrowelRemote not found!")
            return
        end

        -- Store original position for distance check
        local originalPosition = plantToMove:GetPivot().Position

        -- Step 1: Pickup the plant
        print("üîß Picking up plant:", plantToMove.Name)
        local pickupSuccess = TrowelRemote:InvokeServer("Pickup", trowelTool, plantToMove)
        
        if pickupSuccess then
            -- Wait for pickup to fully process (trowel system needs time)
            task.wait(0.8) 
            
            -- Step 2: Place the plant directly at target plant's position
            local placementCFrame = CFrame.new(
                targetPosition.X + math.random(-4, 4), -- Slightly larger random offset
                targetPosition.Y,
                targetPosition.Z + math.random(-4, 4)  -- Slightly larger random offset
            )
            
            print("üîß Placing plant at target location:", placementCFrame.Position)
            
            -- Place the plant
            TrowelRemote:InvokeServer("Place", trowelTool, plantToMove, placementCFrame)
            
            -- Wait for placement animation to complete (trowel system has 0.4s + animation time)
            task.wait(1.2)
            
            -- Check if plant was successfully moved by comparing to original position
            local newPosition = plantToMove:GetPivot().Position
            local distanceMoved = (newPosition - originalPosition).Magnitude
            local distanceToTarget = (newPosition - targetPosition).Magnitude
            
            -- If plant moved at least 5 blocks and is within 15 blocks of target, consider success
            if distanceMoved >= 5 and distanceToTarget <= 15 then
                print("‚úÖ Plant moved successfully! Distance moved:", math.floor(distanceMoved), "blocks")
                moveSuccess = true
            else
                print("‚ùå Plant may not have moved properly. Distance moved:", math.floor(distanceMoved), "blocks")
            end
        else
            print("‚ùå Failed to pickup plant")
        end
    end)
    
    if not success then
        print("‚ùå Error moving plant:", debug.traceback())
    end
    
    -- Clear the moving flag for this specific plant
    currentlyMovingPlants[plantId] = nil
    return moveSuccess
end

-- Main plant moving function
local function performPlantMove()
    if not PlantMoveEnabled then 
        return 
    end
    
    -- Add delay between moves (trowel system needs time: 0.4s + animation = ~2 seconds minimum)
    local currentTime = tick()
    if currentTime - lastMoveTime < 2.5 then
        return -- Not enough time has passed for next move
    end
    
    -- Check if we have plants to move and targets
    local hasToMove = false
    local hasTargets = false
    
    for _, selected in pairs(PlantsToMove) do
        if selected then hasToMove = true break end
    end
    
    for _, selected in pairs(PlantsToMoveTo) do
        if selected then hasTargets = true break end
    end
    
    if not hasToMove or not hasTargets then
        return
    end
    
    -- Find target plant name first
    local targetPlantName = nil
    for targetName, isTargetSelected in pairs(PlantsToMoveTo) do
        if isTargetSelected then
            targetPlantName = targetName
            break
        end
    end
    
    if not targetPlantName then
        return
    end
    
    -- Find the next plant to move from ANY selected type
    local plantToMove = nil
    local plantTypeName = nil
    
    for plantName, isSelected in pairs(PlantsToMove) do
        if isSelected then
            local plantsOfThisType = findPlantsByName(plantName)
            
            -- Look for an unmoved plant of this type
            for _, plant in pairs(plantsOfThisType) do
                local plantId = tostring(plant)
                if not movedPlants[plantId] and not currentlyMovingPlants[plantId] then
                    plantToMove = plant
                    plantTypeName = plantName
                    break
                end
            end
            
            -- If we found a plant to move, break out of the type loop
            if plantToMove then
                break
            end
        end
    end
    
    -- If we found a plant to move, move it
    if plantToMove then
        local plantId = tostring(plantToMove)
        print("üå± Moving", plantToMove.Name, "(" .. plantTypeName .. ") to", targetPlantName, "area")
        
        lastMoveTime = currentTime -- Update last move time BEFORE moving
        
        if movePlant(plantToMove, targetPlantName) then
            -- Mark this plant as moved
            movedPlants[plantId] = true
            print("‚úÖ Plant moved successfully - next plant in ~2.5 seconds...")
        else
            print("‚ùå Plant move failed - will try next plant in ~2.5 seconds...")
        end
    else
        -- No more plants to move - check if we should reset
        local totalUnmovedPlants = 0
        for plantName, isSelected in pairs(PlantsToMove) do
            if isSelected then
                local plantsOfThisType = findPlantsByName(plantName)
                for _, plant in pairs(plantsOfThisType) do
                    local plantId = tostring(plant)
                    if not movedPlants[plantId] then
                        totalUnmovedPlants = totalUnmovedPlants + 1
                    end
                end
            end
        end
        
        if totalUnmovedPlants == 0 then
            print("ÔøΩ All selected plants have been moved! Resetting tracker...")
            -- Reset moved plants tracker to allow moving them again
            movedPlants = {}
        end
    end
end

-- Plant Move toggle
AutoMoveGroupBox:AddToggle("PlantMove", {
    Text = "Auto Move Plants (One by One)",
    Tooltip = "Continuously move ALL selected plant types to target locations one by one using trowel",
    Default = false,
    Callback = function(Value)
        PlantMoveEnabled = Value
        print("[cb] Plant Move toggled:", Value)
        
        if Value then
            Library:Notify("üå± Auto Plant Move enabled! Moving plants one by one...", 3)
            
            -- Clear moved plants tracker for fresh start
            movedPlants = {}
            currentlyMovingPlants = {}
            lastMoveTime = 0 -- Reset timing
            
            -- Start plant move loop
            plantMoveConnection = Services.RunService.Heartbeat:Connect(function()
                performPlantMove()
            end)
        else
            Library:Notify("üå± Auto Plant Move disabled!", 3)
            
            -- Stop plant move loop
            if plantMoveConnection then
                plantMoveConnection:Disconnect()
                plantMoveConnection = nil
            end
            
            -- Clear all trackers
            movedPlants = {}
            currentlyMovingPlants = {}
            lastMoveTime = 0
        end
    end,
})

-- Add reset button
AutoMoveGroupBox:AddButton("Reset Move Tracker", function()
    movedPlants = {}
    currentlyMovingPlants = {}
    lastMoveTime = 0
    Library:Notify("üîÑ Plant move tracker reset! All plants can be moved again.", 3)
    print("üîÑ Move tracker reset - all plants available for moving again")
end)

-- ================================================================
-- AUTO MOVE INITIALIZATION COMPLETE
-- ================================================================
print("üöÄ Auto Move system integrated with Essential tab!")
Library:Notify("üöÄ Auto Move loaded!", 3)

-- Return success indicator
return true 
